/**
 * Discovery and API Docs.
 *
 */
require( 'veneer-service' ).create( function discoveryService( error, app ) {

  app.set( {
    views: __dirname + '/views',
    bind: {
      port: 9130
    },
    config: require( __dirname + '/public/data/config' ),
    sessionSecret: 12345,
    debug: false,
    title: 'API',
    "apiConfigDir": "./public/data/",
    "basicAuth": {
      "username": "",
      "password": ""
    },
    "redis": {
      "host": "localhost",
      "port": 6379,
      "password": "",
      "database": "0"
    }
  } );

  app.use( app.middleware.staticServer( __dirname + '/public' ) );
  app.use( dynamicHelpers );
  app.use( app.router );
  app.disable('view cache');

  app._router.get( '/(:api|)', getAPI );
  app._router.get( '/', listAll );

  // app.use( app.pageSpeed() );

}, module );

/**
 * List All APIs.
 *
 * @param req
 * @param res
 */
function listAll( req, res ) {

  res.locals.apiConfig = req.app.get( 'config' );

  var _hostname = req.param( 'api' ) || req.host;

  res.locals.apiInfo = res.locals.apiConfig[ _hostname ];

  if( !res.locals.apiInfo ) {
    //return res.send( 'no api' );
    return res.render( 'error', { code: 5000 } );
  }

  if( _hostname ) {
    res.locals.apiName = _hostname;

    try {
      res.locals.apiDefinition = require( __dirname + '/public/data/' + _hostname + '.json' );
    } catch( error ) { console.error( error ); }

  } else {
    res.locals.apiInfo = res.locals.apiConfig;
  }

  if( !_hostname || !res.locals.apiDefinition ) {
    return res.render( 'error', { code: 404, title: req.app.get( 'title' ) } );
  }

  res.render( 'listAPIs', {
    title: req.app.get( 'title' )
  });

}

/**
 * Render Single API.
 *
 * @param req
 * @param res
 */
function getAPI( req, res ) {
  // console.log( 'getAPI', req.param( 'api' ) );

  if( req.param( 'api' ) ) {
    res.locals.apiConfig = req.app.get( 'config' );
    res.locals.apiInfo = res.locals.apiConfig[ req.param( 'api' ) ];
    res.locals.apiName = req.param( 'api' );

    try {
      res.locals.apiDefinition = require( __dirname + '/public/data/' + req.param( 'api' ) + '.json' );
    } catch( error ) {
    }

    if( res.locals.apiDefinition && res.locals.apiDefinition.endpoints ) {
      res.send( 'fail' );
      //return res.render( 'api', { name: 'none' } );
    }

  }

  return res.render( 'error', { code: 5000 } );

}

/**
 * Replaces deprecated app.dynamicHelpers that were dropped in Express 3.x.
 *
 * Passes variables to the view.
 *
 * @param req
 * @param res
 * @param next
 */
function dynamicHelpers( req, res, next ) {
  // console.log( 'dynamicHelpers', req.param( 'api' ) );

  req.params = req.params || {};

  req.session = req.session || {
    sessionID: 'VXA7pelQAYBNjytiMitWvtwM',
    cookie: {}
  };

  res.locals.session = req.session;

  next();

}
